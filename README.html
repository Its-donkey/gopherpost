<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Simple Go SMTP Server</title>
</head>
<body>
<h1>Simple Go SMTP Server</h1>
<p>This standalone SMTP server is implemented entirely with the Go standard library. It provides a minimal feature set suitable for local testing or development environments where an external mail transfer agent is not available.</p>
<h2>Features</h2>
<ul>
<li>RFC 5321 inspired command handling (HELO/EHLO, MAIL FROM, RCPT TO, DATA, RSET, NOOP, QUIT).  </li>
<li>Support for accepting multiple recipients per message.</li>
<li>Dot-stuffing handling inside the DATA section.</li>
<li>Connection deadline enforcement to mitigate idle clients.</li>
<li>Automatic message persistence with recipient hashing to protect sensitive metadata.</li>
<li>Outbound delivery with MX lookup, opportunistic STARTTLS, and jittered retry queue.</li>
<li>Optional DKIM signing for outbound messages.</li>
<li>Server-side message size limit (10â€¯MiB) to guard against resource exhaustion.</li>
<li>Built-in instrumentation exposed via <code>/metrics</code> (expvar format).  </li>
<li>Access restricted to localhost clients to prevent unintended relaying.</li>
</ul>
<h2>Usage</h2>
<pre><code class="language-bash">cd smtpserver
# Build the binary
go build
# Or run directly
go run ./...
</code></pre>
<h3>Configuration</h3>
<p>This server is configured entirely through environment variables (automatically loaded from a local <code>.env</code> file when present). Boolean values must be specified as <code>true</code> or <code>false</code>.</p>
<h4>Core runtime</h4>
<pre><code class="language-yml">SMTP_PORT # TCP port to bind for the SMTP listener (default 2525).  
SMTP_HOSTNAME # Hostname advertised in SMTP banners and HELO/EHLO (default system hostname).  
SMTP_BANNER # Custom greeting appended to the initial 220 response (default smtpserver ready).  
SMTP_DEBUG # Enable verbose audit logging when `true` (default `false`).  
SMTP_HEALTH_ADDR # Listen address for the health server (default :8080).  
SMTP_HEALTH_PORT # Override only the port component of the health address (e.g. 9090).  
SMTP_HEALTH_DISABLE # Disable the health endpoint when `true` (default `false`).  
</code></pre>
<h4>Access control</h4>
<pre><code class="language-yml">SMTP_ALLOW_NETWORKS # Comma-separated CIDR blocks/IPs allowed to connect (e.g. 192.0.2.0/24,203.0.113.5). When unset, all connections are rejected.
SMTP_ALLOW_HOSTS # Comma-separated hostnames allowed to connect (e.g. mail.example.com). When unset alongside networks, all connections are rejected.
SMTP_REQUIRE_LOCAL_DOMAIN # Require `MAIL FROM` senders to match `SMTP_HOSTNAME` when `true` (default `true`).  
</code></pre>
<h4>TLS</h4>
<pre><code class="language-yml">SMTP_TLS_DISABLE # Skip loading TLS certificates when `true` (default `false`).  
SMTP_TLS_CERT # Path to the PEM certificate served for STARTTLS (e.g. /etc/ssl/certs/smtp.crt).  
SMTP_TLS_KEY # Path to the PEM private key matching the TLS cert (e.g. /etc/ssl/private/smtp.key).  
</code></pre>
<h4>DKIM</h4>
<pre><code class="language-yml">SMTP_DKIM_SELECTOR # DKIM selector published in DNS (e.g. mail1).  
SMTP_DKIM_KEY_PATH # Filesystem path to the DKIM private key (e.g. /etc/dkim/mail1.key).  
SMTP_DKIM_PRIVATE_KEY # Inline PEM-formatted DKIM private key (e.g. -----BEGIN RSA PRIVATE KEY-----).  
SMTP_DKIM_DOMAIN # Domain to sign messages as when overriding the sender domain (e.g. example.com).  
</code></pre>
<p><strong>Security note:</strong> configure <code>SMTP_ALLOW_NETWORKS</code>, <code>SMTP_ALLOW_HOSTS</code>, and <code>SMTP_REQUIRE_LOCAL_DOMAIN</code> to enforce ingress and sender restrictions. The server lacks authentication, so deploy behind firewalls or proxies and run as a non-root service account.</p>
<h2>Retrieving Stored Messages</h2>
<p>Messages are persisted automatically. On-disk filenames include a message identifier and a hash of the recipient address so personally identifiable information is not exposed through filenames.</p>
<h2>Example Session</h2>
<pre><code>$ telnet localhost 2525
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 localhost Simple Go SMTP Server
HELO example.com
250 localhost greets example.com
MAIL FROM:&lt;alice@example.com&gt;
250 Sender &lt;alice@example.com&gt; OK
RCPT TO:&lt;bob@example.net&gt;
250 Recipient &lt;bob@example.net&gt; OK
DATA
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
Subject: Hello

This is a test email.
.
250 Message accepted for delivery
QUIT
221 localhost signing off
Connection closed by foreign host.
</code></pre>
<h2>Outbound Delivery</h2>
<p>This server now supports direct delivery to recipient domains via MX record resolution.
It performs MX preference sorting, randomises equal-priority records, and upgrades to STARTTLS only when advertised by the remote host.</p>
<h2>Delivery Queue</h2>
<p>Messages that fail to deliver are automatically retried with capped exponential backoff and jitter to avoid thundering herd effects.</p>
<h2>Message Persistence</h2>
<p>Incoming messages are saved to disk under <code>./data/spool/YYYY-MM-DD/</code>. Override the directory by calling <code>storage.SetBaseDir</code> before accepting traffic (useful for tests or containerised deployments).  </p>
<h2>Running the Server</h2>
<p>Set <code>SMTP_PORT=2525</code> (or any open port) and run:</p>
<pre><code>go run .
</code></pre>
<h2>Debugging and Auditing</h2>
<p>Set <code>SMTP_DEBUG=1</code> to enable verbose delivery logs.</p>
<h2>Systemd Integration</h2>
<p>Copy <code>smtpserver.service</code> to <code>/etc/systemd/system/</code> and run:</p>
<pre><code class="language-bash">sudo systemctl enable smtpserver
sudo systemctl start smtpserver
</code></pre>
<h2>TLS Support</h2>
<p>Set <code>SMTP_TLS_CERT</code> and <code>SMTP_TLS_KEY</code> to enable STARTTLS. Certificates are served with a minimum TLS version of 1.2.
The outbound client upgrades to TLS when the remote server advertises the capability, but it never accepts invalid certificates.</p>
<h2>Health Checks &amp; Metrics</h2>
<p>An HTTP endpoint is available at <code>:8080/healthz</code> (override via <code>SMTP_HEALTH_ADDR</code>) for readiness/liveness probes. If the configured port cannot be bound the SMTP server continues without the health listener.
Structured metrics are exported at <code>/metrics</code> in expvar JSON format whenever the health server is running.</p>
</body>
</html>
